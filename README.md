# WeChat Abstractor

åŸºäº Django çš„å¾®ä¿¡èŠå¤©è®°å½•æå–å·¥å…·ã€‚ç³»ç»Ÿä¼šéå†ç”¨æˆ·æä¾›çš„æ¶ˆæ¯æ–‡ä»¶ç›®å½•ï¼ŒæŒ‰ç…§å¯é…ç½®è¿‡æ»¤æ¡ä»¶ï¼ˆèŠå¤©å¯¹è±¡ã€æ¶ˆæ¯ç±»å‹ã€æ—¶é—´èŒƒå›´ã€æ¡æ•°é™åˆ¶ç­‰ï¼‰æ•´ç†æ¶ˆæ¯å†…å®¹ï¼Œå¹¶ä»¥ç½‘é¡µå½¢å¼å±•ç¤ºä¸é¢„è§ˆã€‚

## åŠŸèƒ½ç‰¹æ€§

### æ ¸å¿ƒåŠŸèƒ½
- âœ… **çœŸå®å¾®ä¿¡æ•°æ®åº“æ”¯æŒ**: å®Œå…¨å…¼å®¹å¾®ä¿¡MSGè¡¨æ ¼å¼ (StrTalker, IsSender, CreateTimeç­‰)
- âœ… **å¤šæ ¼å¼è§£æ**: JSONã€CSVã€XMLã€HTMLã€SQLite/DBã€TXT/LOG ç­‰å¸¸è§èŠå¤©å¤‡ä»½æ ¼å¼
- âœ… **ä¼šè¯è¯†åˆ«**: è‡ªåŠ¨è¯†åˆ«å•äººä¼šè¯ã€ç¾¤èŠ(`@chatroom`)ã€å…¬ä¼—å·(`gh_`)
- âœ… **æ™ºèƒ½è¿‡æ»¤**: æŒ‰èŠå¤©å¯¹è±¡ã€æ¶ˆæ¯ç±»å‹ã€æ—¶é—´èŒƒå›´ã€æ•°é‡ç­›é€‰
- âœ… **å¤šåª’ä½“æ”¯æŒ**: å›¾ç‰‡ã€è§†é¢‘ã€éŸ³é¢‘ã€æ–‡ä»¶ã€é“¾æ¥ã€åç‰‡ã€é€šè¯ç­‰8ç§ç±»å‹
- âœ… **ä¼šè¯è§†å›¾**: æŒ‰å¯¹è±¡åˆ†ç»„,æŒ‰æ—¥æœŸäºŒçº§åˆ†ç»„,å±•ç¤ºå®Œæ•´å¯¹è¯æµ
- âœ… **å®æ—¶ç»Ÿè®¡**: é«˜é¢‘è”ç³»äºº Top10ã€æ¶ˆæ¯ç±»å‹åˆ†å¸ƒã€æŒ‰å¤©ç»Ÿè®¡ã€å¤±è´¥æ–‡ä»¶è¿½è¸ª
- âœ… **å¤šç§å¯¼å‡º**: TXTæ–‡æœ¬å¯¼å‡ºã€ç½‘é¡µé¢„è§ˆã€JSONæ•°æ®å¯¼å‡º
- âœ… **å¯æ‰©å±•æ¶æ„**: æœåŠ¡å±‚è®¾è®¡,è½»æ¾æ·»åŠ æ–°è§£æå™¨

### æ¶ˆæ¯ç±»å‹æ”¯æŒ
| ç±»å‹ | å¾®ä¿¡ä»£ç  | æ˜¾ç¤ºå†…å®¹ | å…ƒæ•°æ® |
|------|---------|---------|--------|
| æ–‡æœ¬ | 1 | åŸæ–‡ | - |
| å›¾ç‰‡ | 3 | ç¼©ç•¥å›¾ | url, name, preview |
| è¯­éŸ³ | 34 | æ’­æ”¾å™¨ | url, duration, transcript |
| è§†é¢‘ | 43 | å°é¢+æ’­æ”¾ | url, name, duration, preview |
| æ–‡ä»¶ | 49/6 | ä¸‹è½½é“¾æ¥ | url, name, size, extension |
| é“¾æ¥ | 49/5 | å¡ç‰‡é¢„è§ˆ | url, title, description, cover |
| åç‰‡ | 42 | è”ç³»ä¿¡æ¯ | name, account, phone |
| é€šè¯ | 50 | çŠ¶æ€ä¿¡æ¯ | status, duration, direction |

## å¿«é€Ÿå¼€å§‹

### ç¯å¢ƒè¦æ±‚
- Python 3.11+
- pip / venv
- **Windows + å¾®ä¿¡å®¢æˆ·ç«¯** (å¯é€‰,ç”¨äºè‡ªåŠ¨å¯†é’¥å‘ç°)

### ä¾èµ–è¯´æ˜
- `pycryptodome >= 3.20`: SQLCipheræ•°æ®åº“è§£å¯†(AES-256-CBC)
- `psutil >= 5.9`: Windowsè¿›ç¨‹æ‰«æ(è‡ªåŠ¨å‘ç°å¯†é’¥)

### å®‰è£…æ­¥éª¤
```powershell
python -m venv .venv
.\.venv\Scripts\Activate.ps1
pip install -r requirements.txt
python manage.py migrate  # å½“å‰é¡¹ç›®æ— éœ€æ•°æ®åº“ä¹Ÿå¯è·³è¿‡
python manage.py runserver
```

æµè§ˆå™¨è®¿é—® `http://127.0.0.1:8000/`ï¼ŒæŒ‰é¡µé¢æç¤ºå¡«å†™æ¶ˆæ¯æ–‡ä»¶ç›®å½•å¹¶æäº¤ã€‚

## ç›®å½•ç»“æ„
```
wechat_abstractor/
â”œâ”€â”€ chat_extractor/              # æ ¸å¿ƒåº”ç”¨
â”‚   â”œâ”€â”€ services/               # èŠå¤©è®°å½•è§£ææœåŠ¡
â”‚   â”œâ”€â”€ templates/chat_extractor
â”‚   â””â”€â”€ tests/                  # å•å…ƒæµ‹è¯•ä¸æ ·ä¾‹æ•°æ®
â”œâ”€â”€ wechat_abstractor/          # Django é¡¹ç›®é…ç½®
â”œâ”€â”€ manage.py
â”œâ”€â”€ requirements.txt
â””â”€â”€ README.md
```

## è¿è¡Œæµ‹è¯•
```powershell
# è¿è¡Œæ‰€æœ‰æµ‹è¯•
python manage.py test

# ä»…æµ‹è¯• SQLCipher åŠŸèƒ½
python manage.py test chat_extractor.tests.test_sqlcipher -v 2

# ä»…æµ‹è¯•æå–æœåŠ¡
python manage.py test chat_extractor.tests.test_extraction_service -v 2
```

## SQLCipher åŠ å¯†æ”¯æŒ ğŸ”

### åŠ å¯†æ•°æ®åº“è‡ªåŠ¨è§£å¯†
çœŸå®çš„å¾®ä¿¡æ•°æ®åº“(å¦‚ `MSG0.db`, `MicroMsg.db`, `Media.db`)é€šå¸¸ä½¿ç”¨ **SQLCipher** åŠ å¯†ã€‚æœ¬ç³»ç»Ÿæ”¯æŒä¸‰ç§è§£å¯†æ–¹å¼:

#### 1ï¸âƒ£ è‡ªåŠ¨å¯†é’¥å‘ç° (æ¨è - Windows)
```powershell
# ç¡®ä¿å¾®ä¿¡å®¢æˆ·ç«¯æ­£åœ¨è¿è¡Œ
# ç³»ç»Ÿä¼šè‡ªåŠ¨æ‰«æ WeChat.exe / WeChatWin.dll å†…å­˜
# åœ¨ä¸Šä¼ é¡µé¢ç‚¹å‡»è‡ªåŠ¨å‘ç°çš„å¯†é’¥èŠ¯ç‰‡å³å¯ä½¿ç”¨
```

**å·¥ä½œåŸç†:**
- æ‰«æ `WeChat.exe` è¿›ç¨‹åŠ è½½çš„ `WeChatWin.dll` æ¨¡å—
- æœç´¢è®¾å¤‡æ ‡è¯†ç¬¦(android/iphone/ipad/OHOS)åŠå…¶å‰åç‰¹å®šåç§»ä½ç½®
- æå– 32 å­—èŠ‚å¯†é’¥å¹¶éªŒè¯èƒ½å¦è§£å¯† `Media.db`
- éªŒè¯é€šè¿‡ååœ¨é¡µé¢å±•ç¤ºå¯ç‚¹å‡»çš„å¯†é’¥èŠ¯ç‰‡

**ç³»ç»Ÿè¦æ±‚:**
- âœ… Windows æ“ä½œç³»ç»Ÿ
- âœ… å¾®ä¿¡å®¢æˆ·ç«¯æ­£åœ¨è¿è¡Œ
- âœ… å·²å®‰è£… `psutil` ä¾èµ–

#### 2ï¸âƒ£ æ‰‹åŠ¨è¾“å…¥å¯†é’¥
```powershell
# ä»å…¶ä»–å·¥å…·(å¦‚ wechatDataBackup)è·å– 64 ä½åå…­è¿›åˆ¶å¯†é’¥
# ç¤ºä¾‹: a1b2c3d4e5f67890...  (64å­—ç¬¦)
```
åœ¨ä¸Šä¼ è¡¨å•çš„ **"SQLCipher å¯†é’¥"** å­—æ®µç²˜è´´å¯†é’¥å³å¯ã€‚

#### 3ï¸âƒ£ æ˜æ–‡æ•°æ®åº“
å¦‚æœæ•°æ®åº“æœªåŠ å¯†,ç³»ç»Ÿè‡ªåŠ¨è¯†åˆ«å¹¶ç›´æ¥è§£æ(æ— éœ€æä¾›å¯†é’¥)ã€‚

### é”™è¯¯è¯Šæ–­

| é”™è¯¯ä¿¡æ¯ | åŸå›  | è§£å†³æ–¹æ¡ˆ |
|---------|------|---------|
| `SQLCipher database but no decryption key provided` | åŠ å¯†æ•°æ®åº“ä½†æœªæä¾›å¯†é’¥ | å¯åŠ¨å¾®ä¿¡å®¢æˆ·ç«¯æˆ–æ‰‹åŠ¨è¾“å…¥å¯†é’¥ |
| `file is not a database` | å¯†é’¥é”™è¯¯æˆ–æ–‡ä»¶æŸå | æ£€æŸ¥å¯†é’¥æ ¼å¼(64ä½åå…­è¿›åˆ¶)æˆ–é‡æ–°å¯¼å‡ºæ•°æ®åº“ |
| `Missing pycryptodome dependency` | æœªå®‰è£…åŠ å¯†åº“ | `pip install pycryptodome>=3.20` |
| `Cannot detect keys on non-Windows` | éWindowså¹³å° | ä½¿ç”¨æ‰‹åŠ¨è¾“å…¥å¯†é’¥æ–¹å¼ |

### æŠ€æœ¯ç»†èŠ‚
- **åŠ å¯†ç®—æ³•**: PBKDF2-HMAC-SHA1 (64000 iterations) + AES-256-CBC
- **å¯†é’¥æ ¼å¼**: 64 ä½åå…­è¿›åˆ¶å­—ç¬¦ä¸² (32 å­—èŠ‚)
- **éªŒè¯æœºåˆ¶**: æ¯ä¸ªæ•°æ®é¡µåŒ…å« HMAC-SHA1 æ ¡éªŒ,ç¡®ä¿å¯†é’¥æ­£ç¡®æ€§
- **ç¼“å­˜ç­–ç•¥**: è§£å¯†åçš„æ•°æ®åº“ç¼“å­˜è‡³ `%TEMP%\wechat_abstractor\decrypted_db\` (åŸºäº SHA1 å‘½å)

### æ€§èƒ½ä¼˜åŒ–å»ºè®®
```python
# å¤§å‹æ•°æ®åº“(>100MB)é¦–æ¬¡è§£å¯†è€—æ—¶ 5-30 ç§’
# åç»­è®¿é—®ç›´æ¥è¯»å–ç¼“å­˜,å‡ ä¹æ— å»¶è¿Ÿ

# æ‰¹é‡å¤„ç†æ—¶å»ºè®®:
# 1. ç¡®ä¿åŒä¸€æ‰¹æ–‡ä»¶ä½¿ç”¨ç›¸åŒå¯†é’¥
# 2. é¢„çƒ­ç¼“å­˜:å…ˆè§£å¯† Media.db (è¾ƒå°)éªŒè¯å¯†é’¥
# 3. ä½¿ç”¨ include_subdirectories=False é™åˆ¶æ‰«æèŒƒå›´
```

## æ•°æ®åº“æ ¼å¼æ”¯æŒ

### å¾®ä¿¡çœŸå®æ•°æ®åº“ (MSGè¡¨)
ç³»ç»Ÿè‡ªåŠ¨è¯†åˆ«å¹¶æ”¯æŒä»¥ä¸‹å­—æ®µ:
```sql
CREATE TABLE MSG (
    localId INTEGER PRIMARY KEY,
    MsgSvrID INTEGER,
    Type INTEGER,              -- æ¶ˆæ¯ç±»å‹ä»£ç 
    SubType INTEGER,           -- å­ç±»å‹
    IsSender INTEGER,          -- 0=æ¥æ”¶ 1=å‘é€
    CreateTime INTEGER,        -- Unixæ—¶é—´æˆ³
    StrTalker TEXT,           -- ä¼šè¯å¯¹è±¡(å¾®ä¿¡IDæˆ–ç¾¤ID)
    StrContent TEXT,          -- æ¶ˆæ¯å†…å®¹
    CompressContent BLOB,     -- å‹ç¼©å†…å®¹
    BytesExtra BLOB           -- é¢å¤–æ•°æ®(XML)
)
```

### æ ‡å‡†æ ¼å¼ (å…¼å®¹æ¨¡å¼)
ä¹Ÿæ”¯æŒé€šç”¨å‘½å:
- `talker` / `Talker` / `StrTalker`
- `sender` / `Sender`
- `createTime` / `CreateTime` / `timestamp`
- `isSend` / `IsSend` / `is_send`

## æµ‹è¯•è¯´æ˜

```powershell
# è¿è¡Œæ‰€æœ‰æµ‹è¯•
python manage.py test

# è¿è¡Œç‰¹å®šæµ‹è¯•
python manage.py test chat_extractor.tests.test_extraction_service

# è¯¦ç»†è¾“å‡º
python manage.py test -v 2
```

æµ‹è¯•æ•°æ®ä½äº `chat_extractor/tests/data/`:
- `sample.json`: JSONæ ¼å¼ç¤ºä¾‹
- `sample.txt`: æ–‡æœ¬æ ¼å¼ç¤ºä¾‹  
- `wechat_msg.db`: å¾®ä¿¡æ•°æ®åº“æ ¼å¼ç¤ºä¾‹

## ä½¿ç”¨æŠ€å·§

### 1. å¤„ç†å¤§æ–‡ä»¶
```python
# è®¾ç½®åˆç†çš„limité¿å…å†…å­˜æº¢å‡º
limit=1000

# åªæ‰«ææŒ‡å®šç›®å½•
include_subdirectories=False

# ä½¿ç”¨ç±»å‹å’Œè”ç³»äººè¿‡æ»¤
message_types=["text"]
contacts=["ç‰¹å®šè”ç³»äºº"]
```

### 2. ç¾¤èŠè¯†åˆ«
ç³»ç»Ÿè‡ªåŠ¨è¯†åˆ« `xxxxx@chatroom` æ ¼å¼çš„ç¾¤ID,å¯åœ¨å…ƒæ•°æ®ä¸­æŸ¥çœ‹:
```python
if message.metadata.get("is_chatroom") == "true":
    print(f"è¿™æ˜¯ç¾¤èŠæ¶ˆæ¯: {message.conversation}")
```

### 3. å¤šåª’ä½“è®¿é—®
```python
for message in results:
    meta = message.display_meta
    if meta.get("kind") == "image":
        print(f"å›¾ç‰‡URL: {meta['url']}")
        print(f"æ–‡ä»¶å: {meta['name']}")
```

## æ€§èƒ½ä¸å®‰å…¨

- âœ… æµå¼è§£æ,å†…å­˜å‹å¥½
- âœ… åªè¯»æ•°æ®åº“è¿æ¥
- âœ… HTMLå†…å®¹è‡ªåŠ¨è½¬ä¹‰
- âœ… SQLæ³¨å…¥é˜²æŠ¤
- âœ… æ–‡ä»¶è·¯å¾„éªŒè¯

## ä¸‹ä¸€æ­¥è§„åˆ’

### é«˜ä¼˜å…ˆçº§
- [ ] è”ç³»äººåç§°æ˜ å°„ (å¾®ä¿¡ID â†’ æ˜µç§°/å¤‡æ³¨)
- [ ] ç¾¤èŠæˆå‘˜åˆ—è¡¨è§£æ
- [ ] CSV/ExcelæŠ¥è¡¨å¯¼å‡º

### ä¸­ä¼˜å…ˆçº§
- [ ] æ¶ˆæ¯å…¨æ–‡æœç´¢
- [ ] æ—¶é—´çº¿å¯è§†åŒ–
- [ ] è¡¨æƒ…åŒ…èµ„æºç®¡ç†

æŸ¥çœ‹å®Œæ•´åŠŸèƒ½è¯´æ˜: [FEATURES.md](FEATURES.md)

æ¬¢è¿æäº¤ Issue æˆ– PRï¼Œä¸€èµ·å®Œå–„é¡¹ç›®!
