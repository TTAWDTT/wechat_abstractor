<!DOCTYPE html>
<html lang="zh">
{% load static %}
<head>
    <meta charset="utf-8">
    <title>微信聊天记录提取</title>
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" integrity="sha384-QWTKZyjpPEjISv5WaRU9OFeRpok6YctnYmDr5pNlyT2bRjXh0JMhjY6hW+ALEwIH" crossorigin="anonymous">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css">
    <link rel="stylesheet" href="{% static 'chat_extractor/styles.css' %}">
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
</head>
<body class="bg-canvas">
<!-- 主题切换按钮 -->
<button class="theme-toggle" id="theme-toggle" aria-label="切换主题">
    <svg class="sun-icon" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
        <circle cx="12" cy="12" r="5"/>
        <line x1="12" y1="1" x2="12" y2="3"/>
        <line x1="12" y1="21" x2="12" y2="23"/>
        <line x1="4.22" y1="4.22" x2="5.64" y2="5.64"/>
        <line x1="18.36" y1="18.36" x2="19.78" y2="19.78"/>
        <line x1="1" y1="12" x2="3" y2="12"/>
        <line x1="21" y1="12" x2="23" y2="12"/>
        <line x1="4.22" y1="19.78" x2="5.64" y2="18.36"/>
        <line x1="18.36" y1="5.64" x2="19.78" y2="4.22"/>
    </svg>
    <svg class="moon-icon" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
        <path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"/>
    </svg>
</button>

<header class="hero-section py-5">
    <div class="container-xxl">
        <div class="row align-items-center g-4">
            <div class="col-lg-7">
                <div class="hero-copy animate-fade-in">
                    <span class="badge hero-badge text-uppercase">Pro+</span>
                    <h1 class="display-5 fw-bold mb-3">一站式微信聊天档案工作台</h1>
                    <p class="lead mb-4 text-white-50">自动识别 SQLCipher 加密数据库、智能聚合多媒体消息与统计洞察，让企业级的取证效率触手可及。</p>
                    <ul class="hero-status list-unstyled d-flex flex-wrap gap-3 mb-0">
                        <li class="hero-status-item {% if is_windows %}status-on{% else %}status-off{% endif %} animate-scale-in animate-delay-1">
                            <span class="label">系统</span><span class="value">{% if is_windows %}Windows{% else %}需 Windows{% endif %}</span>
                        </li>
                        <li class="hero-status-item {% if sqlcipher_ready %}status-on{% else %}status-off{% endif %} animate-scale-in animate-delay-2">
                            <span class="label">PyCryptodome</span><span class="value">{% if sqlcipher_ready %}已就绪{% else %}待安装{% endif %}</span>
                        </li>
                        <li class="hero-status-item {% if has_psutil %}status-on{% else %}status-off{% endif %} animate-scale-in animate-delay-3">
                            <span class="label">psutil</span><span class="value">{% if has_psutil %}可用{% else %}待安装{% endif %}</span>
                        </li>
                        <li class="hero-status-item {% if detected_keys %}status-on{% else %}status-pending{% endif %} animate-scale-in animate-delay-4">
                            <span class="label">实时密钥</span><span class="value">{{ detected_keys|length }}</span>
                        </li>
                    </ul>
                </div>
            </div>
            <div class="col-lg-5">
                <div class="hero-visual glass-panel shadow-lg animate-fade-in animate-delay-2">
                    <div class="visual-header">
                        <span class="dot"></span>
                        <span class="dot"></span>
                        <span class="dot"></span>
                        <span class="caption">SQLCipher 解密流程</span>
                    </div>
                    <div class="visual-body">
                        <ol class="visual-flow">
                            <li>读取 WeChatWin.dll 内存</li>
                            <li>定位设备指纹并解析 32 字节密钥</li>
                            <li>验证密钥并执行 AES-CBC 解密</li>
                            <li>生成临时明文库供提取分析</li>
                        </ol>
                        <div class="visual-footer text-white-50 small">只需保持微信客户端登录，即可秒级完成批量解密。</div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</header>

<main class="container-xxl py-5">
    <div class="row g-4 g-xl-5 align-items-start">
        <div class="col-xl-4">
            <div class="glass-card form-card shadow-lg h-100 animate-fade-in animate-delay-1">
                <!-- 快捷配置预设 -->
                <div class="quick-presets mb-4">
                    <div class="d-flex justify-content-between align-items-center mb-2">
                        <h3 class="h6 mb-0">快捷配置</h3>
                        <button type="button" class="btn btn-sm btn-link text-decoration-none p-0" id="toggle-presets">
                            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <polyline points="6 9 12 15 18 9"/>
                            </svg>
                        </button>
                    </div>
                    <div class="preset-buttons d-none" id="preset-buttons">
                        <button type="button" class="btn btn-outline-primary btn-sm" data-preset="recent-week">最近一周</button>
                        <button type="button" class="btn btn-outline-primary btn-sm" data-preset="recent-month">最近一月</button>
                        <button type="button" class="btn btn-outline-primary btn-sm" data-preset="text-only">仅文本消息</button>
                        <button type="button" class="btn btn-outline-primary btn-sm" data-preset="media-only">仅多媒体</button>
                        <button type="button" class="btn btn-outline-danger btn-sm" id="clear-form">清空表单</button>
                    </div>
                </div>
                
                <form id="extraction-form" method="post" novalidate>
                    {% csrf_token %}
                    {% if error %}
                        <div class="alert alert-danger mb-4" role="alert">{{ error }}</div>
                    {% endif %}

                    <section class="form-section">
                        <div class="section-header">
                            <h2 class="section-title">基础配置</h2>
                            <p class="section-sub">指定聊天数据的根目录与导出范围。</p>
                        </div>
                        {% with field=form.base_dir %}
                            <div class="floating-field">
                                <label class="form-label" for="{{ field.id_for_label }}">{{ field.label }}</label>
                                {{ field }}
                                {% if field.help_text %}<div class="form-text">{{ field.help_text }}</div>{% endif %}
                                {% for item in field.errors %}<div class="invalid-feedback d-block">{{ item }}</div>{% endfor %}
                            </div>
                        {% endwith %}
                        <div class="form-switch advanced-switch">
                            {{ form.include_subdirectories }}
                            <label class="form-check-label" for="{{ form.include_subdirectories.id_for_label }}">{{ form.include_subdirectories.label }}</label>
                        </div>
                        {% for item in form.include_subdirectories.errors %}<div class="invalid-feedback d-block">{{ item }}</div>{% endfor %}
                    </section>

                    <section class="form-section">
                        <div class="section-header">
                            <h2 class="section-title">筛选条件</h2>
                            <p class="section-sub">按联系人、消息类型或自定义关键字限定输出。</p>
                        </div>
                        {% with field=form.contacts %}
                            <div class="floating-field">
                                <label class="form-label" for="{{ field.id_for_label }}">{{ field.label }}</label>
                                {{ field }}
                                {% if field.help_text %}<div class="form-text">{{ field.help_text }}</div>{% endif %}
                                {% for item in field.errors %}<div class="invalid-feedback d-block">{{ item }}</div>{% endfor %}
                            </div>
                        {% endwith %}
                        <div class="floating-field">
                            <label class="form-label">{{ form.message_types.label }}</label>
                            <div class="checkbox-grid">
                                {{ form.message_types }}
                            </div>
                            {% if form.message_types.help_text %}<div class="form-text">{{ form.message_types.help_text }}</div>{% endif %}
                            {% for item in form.message_types.errors %}<div class="invalid-feedback d-block">{{ item }}</div>{% endfor %}
                        </div>
                        {% with field=form.custom_message_types %}
                            <div class="floating-field">
                                <label class="form-label" for="{{ field.id_for_label }}">{{ field.label }}</label>
                                {{ field }}
                                {% if field.help_text %}<div class="form-text">{{ field.help_text }}</div>{% endif %}
                                {% for item in field.errors %}<div class="invalid-feedback d-block">{{ item }}</div>{% endfor %}
                            </div>
                        {% endwith %}
                        {% with field=form.limit %}
                            <div class="floating-field">
                                <label class="form-label" for="{{ field.id_for_label }}">{{ field.label }}</label>
                                {{ field }}
                                {% if field.help_text %}<div class="form-text">{{ field.help_text }}</div>{% endif %}
                                {% for item in field.errors %}<div class="invalid-feedback d-block">{{ item }}</div>{% endfor %}
                            </div>
                        {% endwith %}
                    </section>

                    <section class="form-section">
                        <div class="section-header">
                            <h2 class="section-title">时间窗口</h2>
                            <p class="section-sub">按精确时间范围过滤消息。</p>
                        </div>
                        <div class="row g-3">
                            <div class="col-12">
                                {% with field=form.start_time %}
                                    <div class="floating-field">
                                        <label class="form-label" for="{{ field.id_for_label }}">{{ field.label }}</label>
                                        {{ field }}
                                        {% for item in field.errors %}<div class="invalid-feedback d-block">{{ item }}</div>{% endfor %}
                                    </div>
                                {% endwith %}
                            </div>
                            <div class="col-12">
                                {% with field=form.end_time %}
                                    <div class="floating-field">
                                        <label class="form-label" for="{{ field.id_for_label }}">{{ field.label }}</label>
                                        {{ field }}
                                        {% for item in field.errors %}<div class="invalid-feedback d-block">{{ item }}</div>{% endfor %}
                                    </div>
                                {% endwith %}
                            </div>
                        </div>
                    </section>

                    <section class="form-section">
                        <div class="section-header">
                            <h2 class="section-title">高级 · SQLCipher</h2>
                            <p class="section-sub">可手动输入密钥，或一键应用实时捕获结果。</p>
                        </div>
                        {% with field=form.wechat_db_key %}
                            <div class="floating-field">
                                <label class="form-label" for="{{ field.id_for_label }}">{{ field.label }}</label>
                                <div class="key-input-group">
                                    {{ field }}
                                    <button class="btn btn-sm btn-outline-secondary" type="button" id="clear-key-btn">清除</button>
                                </div>
                                {% if field.help_text %}<div class="form-text">{{ field.help_text }}</div>{% endif %}
                                {% for item in field.errors %}<div class="invalid-feedback d-block">{{ item }}</div>{% endfor %}
                            </div>
                        {% endwith %}

                        <div class="key-helper">
                            <div class="d-flex align-items-center justify-content-between mb-2">
                                <h3 class="key-title mb-0">自动检测到的密钥</h3>
                                <span class="badge rounded-pill bg-dark-subtle text-dark">实验功能</span>
                            </div>
                            <p class="text-muted small mb-2">点击卡片即可填充密钥；若安装目录匹配，将自动匹配当前数据集。</p>
                            <div class="key-chip-grid" id="detected-key-grid">
                                {% if detected_keys %}
                                    {% for item in detected_keys %}
                                        <button type="button" class="key-chip" data-wechat-key="{{ item.key_hex }}" data-base="{{ item.base_path }}" data-account="{{ item.account }}">
                                            <span class="chip-title">{{ item.account|default:"未命名账号" }}</span>
                                            <span class="chip-sub">{{ item.base_path }}</span>
                                            <span class="chip-key">{{ item.key_hex }}</span>
                                        </button>
                                    {% endfor %}
                                {% else %}
                                    <div class="empty-state text-muted">
                                        <strong>暂未捕获密钥</strong>
                                        <ul class="mb-0 small mt-2">
                                            <li>请确认客户端已登录，且保持 WeChat.exe 运行。</li>
                                            <li>当前仅支持 Windows 平台的自动密钥提取。</li>
                                            {% if not has_psutil %}<li>执行 <code>pip install psutil</code> 以启用进程扫描。</li>{% endif %}
                                            {% if not sqlcipher_ready %}<li>执行 <code>pip install pycryptodome</code> 以启用解密。</li>{% endif %}
                                        </ul>
                                    </div>
                                {% endif %}
                            </div>
                            <div class="key-feedback text-muted small mt-2" id="key-feedback"></div>
                        </div>
                    </section>

                    <div class="form-actions d-flex flex-column gap-2 mt-4">
                        <button class="btn btn-primary btn-lg w-100" type="submit">
                            <svg width="20" height="20" class="me-2" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="display: inline-block; vertical-align: middle;">
                                <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/>
                                <polyline points="7 10 12 15 17 10"/>
                                <line x1="12" y1="15" x2="12" y2="3"/>
                            </svg>
                            立即提取
                        </button>
                        <button class="btn btn-outline-secondary w-100" type="button" id="preview-button">
                            <svg width="18" height="18" class="me-2" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="display: inline-block; vertical-align: middle;">
                                <path d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z"/>
                                <circle cx="12" cy="12" r="3"/>
                            </svg>
                            预览前 50 条
                        </button>
                        <button class="btn btn-outline-success w-100" type="submit" formaction="{% url 'chat_extractor:export' %}" formtarget="_blank">
                            <svg width="18" height="18" class="me-2" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="display: inline-block; vertical-align: middle;">
                                <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/>
                                <polyline points="14 2 14 8 20 8"/>
                                <line x1="16" y1="13" x2="8" y2="13"/>
                                <line x1="16" y1="17" x2="8" y2="17"/>
                                <polyline points="10 9 9 9 8 9"/>
                            </svg>
                            导出为 TXT
                        </button>
                    </div>
                    
                    <!-- 快捷键提示 -->
                    <div class="keyboard-shortcuts mt-3 p-2 text-muted small">
                        <div class="d-flex justify-content-between align-items-center mb-1">
                            <span>💡 快捷键</span>
                        </div>
                        <div class="d-flex flex-column gap-1">
                            <div><kbd>Ctrl + Enter</kbd> 提交表单</div>
                            <div><kbd>Ctrl + K</kbd> 聚焦搜索</div>
                            <div><kbd>Esc</kbd> 清除搜索</div>
                        </div>
                    </div>
                </form>
            </div>
        </div>
        <div class="col-xl-8">
            <div class="glass-card results-card shadow-lg animate-fade-in animate-delay-2">
                <div class="results-header d-flex flex-wrap gap-3 align-items-center justify-content-between mb-4">
                    <div>
                        <h2 class="h4 mb-1">提取结果概览</h2>
                        <p class="text-muted small mb-0">实时洞察会话动态、消息结构与数据质量。</p>
                    </div>
                    <div class="d-flex gap-2 align-items-center">
                        <input type="search" class="form-control form-control-sm" id="search-messages" placeholder="搜索消息..." style="width: 200px;">
                        <span class="pill-counter" id="current-count">{% if stats %}当前显示 {{ results|length }} / {{ stats.matched_messages }}{% else %}暂无结果{% endif %}</span>
                    </div>
                </div>

                <div id="stats-section" class="stats-grid {% if not stats %}d-none{% endif %}">
                    <div class="stat-card">
                        <div class="stat-label">匹配消息</div>
                        <div class="stat-value" id="stat-matched">{{ stats.matched_messages|default:"0" }}</div>
                        <div class="stat-sub">总计 <span id="stat-total">{{ stats.total_messages|default:"0" }}</span></div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-label">扫描文件</div>
                        <div class="stat-value" id="stat-scanned">{{ stats.scanned_files|default:"0" }}</div>
                        <div class="stat-sub">成功 <span id="stat-parsed">{{ stats.parsed_files|default:"0" }}</span></div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-label">时间范围</div>
                        <div class="stat-value stat-value-sm" id="stat-range">{% if stats %}{{ stats.earliest_timestamp }}<br>~<br>{{ stats.latest_timestamp }}{% else %}--{% endif %}</div>
                        <div class="stat-sub" id="stat-contacts">{{ stats.contacts_found|join:", " }}</div>
                    </div>
                </div>

                <!-- 数据可视化图表 -->
                <div id="chart-section" class="mt-4 {% if not stats %}d-none{% endif %}">
                    <div class="insight-card">
                        <div class="insight-header d-flex justify-content-between align-items-center">
                            <span>消息活跃度趋势</span>
                            <button type="button" class="btn btn-sm btn-link text-decoration-none p-0" id="toggle-chart">
                                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                    <polyline points="6 9 12 15 18 9"/>
                                </svg>
                            </button>
                        </div>
                        <div id="activity-chart" class="chart-container mt-3">
                            <canvas id="messageChart" style="max-height: 250px;"></canvas>
                        </div>
                    </div>
                </div>

                <div class="row g-3 mt-4">
                    <div class="col-lg-6">
                        <div class="insight-card h-100">
                            <div class="insight-header">高频联系人</div>
                            <ul class="list-group list-group-flush small" id="top-contacts">
                                {% if stats and stats.top_contacts %}
                                    {% for item in stats.top_contacts %}
                                        <li class="list-group-item d-flex justify-content-between align-items-center">
                                            <span>{{ item.label }}</span>
                                            <span class="badge text-bg-primary">{{ item.count }}</span>
                                        </li>
                                    {% endfor %}
                                {% else %}
                                    <li class="list-group-item text-muted">暂无数据</li>
                                {% endif %}
                            </ul>
                        </div>
                    </div>
                    <div class="col-lg-6">
                        <div class="insight-card h-100">
                            <div class="insight-header">消息类型分布</div>
                            <ul class="list-group list-group-flush small" id="type-breakdown">
                                {% if stats and stats.message_type_breakdown %}
                                    {% for item in stats.message_type_breakdown %}
                                        <li class="list-group-item d-flex justify-content-between align-items-center">
                                            <span>{{ item.label }}</span>
                                            <span class="badge text-bg-info">{{ item.count }}</span>
                                        </li>
                                    {% endfor %}
                                {% else %}
                                    <li class="list-group-item text-muted">暂无数据</li>
                                {% endif %}
                            </ul>
                        </div>
                    </div>
                </div>

                <div class="insight-card mt-4">
                    <div class="insight-header">按天统计</div>
                    <ul class="list-group list-group-flush small" id="daily-breakdown">
                        {% if stats and stats.daily_breakdown %}
                            {% for item in stats.daily_breakdown %}
                                <li class="list-group-item d-flex justify-content-between align-items-center">
                                    <span>{{ item.label }}</span>
                                    <span class="badge text-bg-secondary">{{ item.count }}</span>
                                </li>
                            {% endfor %}
                        {% else %}
                            <li class="list-group-item text-muted">暂无数据</li>
                        {% endif %}
                    </ul>
                </div>

                <div id="failed-files" class="alert alert-warning small mt-4 {% if not stats or not stats.failed_files %}d-none{% endif %}">
                    <strong>解析失败文件</strong>
                    <ul class="mb-0 mt-2" id="failed-files-list">
                        {% if stats and stats.failed_files %}
                            {% for failure in stats.failed_files %}<li>{{ failure }}</li>{% endfor %}
                        {% endif %}
                    </ul>
                </div>

                <ul class="nav nav-tabs custom-tabs mt-4" id="result-tabs" role="tablist">
                    <li class="nav-item" role="presentation">
                        <button class="nav-link active" id="table-tab" data-bs-toggle="tab" data-bs-target="#table-view" type="button" role="tab">表格视图</button>
                    </li>
                    <li class="nav-item" role="presentation">
                        <button class="nav-link" id="thread-tab" data-bs-toggle="tab" data-bs-target="#thread-view" type="button" role="tab">
                            会话视图 <span class="badge text-bg-secondary ms-1" id="thread-count">{{ threads|length }}</span>
                        </button>
                    </li>
                </ul>
                <div class="tab-content mt-3">
                    <div class="tab-pane fade show active" id="table-view" role="tabpanel">
                        <div class="table-responsive luxe-table">
                            <table class="table table-hover table-sm align-middle">
                                <thead>
                                <tr>
                                    <th scope="col">会话</th>
                                    <th scope="col">时间</th>
                                    <th scope="col">发送人</th>
                                    <th scope="col">方向</th>
                                    <th scope="col">类型</th>
                                    <th scope="col">内容</th>
                                    <th scope="col">来源文件</th>
                                </tr>
                                </thead>
                                <tbody id="messages-body">
                                {% for message in results %}
                                    <tr>
                                        <td><span class="badge text-bg-light">{{ message.conversation }}</span></td>
                                        <td>{{ message.timestamp }}</td>
                                        <td>{{ message.sender }}</td>
                                        <td>
                                            {% if message.direction == 'outgoing' %}
                                                <span class="badge text-bg-success">发出</span>
                                            {% elif message.direction == 'incoming' %}
                                                <span class="badge text-bg-primary">接收</span>
                                            {% else %}
                                                <span class="badge text-bg-secondary">未知</span>
                                            {% endif %}
                                        </td>
                                        <td><span class="badge text-bg-secondary">{{ message.display_type }}</span></td>
                                        <td><pre class="mb-0 text-wrap" style="white-space: pre-wrap;">{{ message.display_content }}</pre></td>
                                        <td><span class="badge text-bg-light">{{ message.file_path }}</span></td>
                                    </tr>
                                {% empty %}
                                    <tr>
                                        <td colspan="7" class="text-center text-muted">暂无消息。</td>
                                    </tr>
                                {% endfor %}
                                </tbody>
                            </table>
                        </div>
                    </div>
                    <div class="tab-pane fade" id="thread-view" role="tabpanel">
                        <div id="thread-container">
                            {% if threads %}
                                {% for thread in threads %}
                                    <div class="thread-card" data-thread="{{ thread.name }}">
                                        <div class="thread-header">
                                            <div>
                                                <h3 class="h6 mb-1">{{ thread.name }}</h3>
                                                <span class="text-muted small">共 {{ thread.count }} 条消息</span>
                                            </div>
                                        </div>
                                        <div class="thread-body">
                                            <ul class="list-group list-group-flush thread-messages">
                                                {% for message in thread.messages %}
                                                    <li class="list-group-item">
                                                        <div class="d-flex justify-content-between align-items-center mb-1">
                                                            <span class="fw-semibold">{{ message.sender }}</span>
                                                            <span class="text-muted small">{{ message.timestamp }}</span>
                                                        </div>
                                                        <div class="mb-2 small">
                                                            {% if message.direction == 'outgoing' %}
                                                                <span class="badge text-bg-success me-1">发出</span>
                                                            {% elif message.direction == 'incoming' %}
                                                                <span class="badge text-bg-primary me-1">接收</span>
                                                            {% else %}
                                                                <span class="badge text-bg-secondary me-1">未知</span>
                                                            {% endif %}
                                                            <span class="badge text-bg-secondary">{{ message.display_type }}</span>
                                                        </div>
                                                        <div class="message-content small">{{ message.display_content }}</div>
                                                    </li>
                                                {% endfor %}
                                            </ul>
                                        </div>
                                    </div>
                                {% endfor %}
                            {% else %}
                                <p class="text-muted">暂无会话数据。</p>
                            {% endif %}
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</main>

{% if results is not None %}{{ results|json_script:"initial-messages" }}{% else %}<script id="initial-messages" type="application/json">[]</script>{% endif %}
{% if stats is not None %}{{ stats|json_script:"initial-stats" }}{% else %}<script id="initial-stats" type="application/json">null</script>{% endif %}
{% if threads is not None %}{{ threads|json_script:"initial-threads" }}{% else %}<script id="initial-threads" type="application/json">[]</script>{% endif %}
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js" integrity="sha384-YvpcrYf0tY3lHB60NNkmXc5s9fDVZLESaAA55NDzOxhy9GkcIdslK1eN7N6jIeHz" crossorigin="anonymous"></script>
<script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>
<script>
    flatpickr("#id_start_time", {enableTime: true, dateFormat: "Y-m-d H:i"});
    flatpickr("#id_end_time", {enableTime: true, dateFormat: "Y-m-d H:i"});

    (function () {
        const form = document.getElementById("extraction-form");
        const previewButton = document.getElementById("preview-button");
        const clearKeyButton = document.getElementById("clear-key-btn");
        const keyInput = document.getElementById("id_wechat_db_key");
        const baseDirInput = document.getElementById("id_base_dir");
        const keyFeedback = document.getElementById("key-feedback");
        const keyButtons = document.querySelectorAll("[data-wechat-key]");
        const messageBody = document.getElementById("messages-body");
        const dateFromInput = document.getElementById("id_date_from");
        const dateToInput = document.getElementById("id_date_to");
        const statsSection = document.getElementById("stats-section");
        const statMatched = document.getElementById("stat-matched");
        const statTotal = document.getElementById("stat-total");
        const statScanned = document.getElementById("stat-scanned");
        const statParsed = document.getElementById("stat-parsed");
        const statRange = document.getElementById("stat-range");
        const statContacts = document.getElementById("stat-contacts");
        const topContactsList = document.getElementById("top-contacts");
        const typeBreakdownList = document.getElementById("type-breakdown");
        const dailyBreakdownList = document.getElementById("daily-breakdown");
        const failedFilesAlert = document.getElementById("failed-files");
        const failedFilesList = document.getElementById("failed-files-list");
        const threadContainer = document.getElementById("thread-container");
        const threadCountBadge = document.getElementById("thread-count");
        const currentCountBadge = document.getElementById("current-count");
        const chartSection = document.getElementById("chart-section");
        const chartCanvas = document.getElementById("messageChart");
        const searchInput = document.getElementById("search-messages");
        let latestStats = null;
        let messageChart = null;
        let allMessages = [];

        function escapeHtml(value) {
            const map = {"&": "&amp;", "<": "&lt;", ">": "&gt;", '"': "&quot;", "'": "&#39;"};
            return (value ?? "").replace(/[&<>"']/g, (match) => map[match] || match);
        }

        function renderMediaContent(message) {
            const meta = message.display_meta || {};
            const kind = meta.kind;
            if (kind === "image") {
                const url = meta.url || "";
                const preview = meta.preview || url;
                const name = meta.name || "图片";
                return `<div class="message-media">
                    <img src="${escapeHtml(preview)}" alt="${escapeHtml(name)}" class="img-thumbnail" style="max-width: 200px; cursor: pointer;" onclick="window.open('${escapeHtml(url)}', '_blank')">
                    <div class="small text-muted">${escapeHtml(name)}</div>
                </div>`;
            }
            if (kind === "video") {
                const url = meta.url || "";
                const name = meta.name || "视频";
                const duration = meta.duration || "";
                const preview = meta.preview || "";
                return `<div class="message-media">
                    ${preview ? `<img src="${escapeHtml(preview)}" class="img-thumbnail mb-1" style="max-width: 200px;">` : ""}
                    <div><a href="${escapeHtml(url)}" target="_blank" class="btn btn-sm btn-outline-primary">▶ ${escapeHtml(name)}</a></div>
                    ${duration ? `<div class="small text-muted">${escapeHtml(duration)}</div>` : ""}
                </div>`;
            }
            if (kind === "audio") {
                const url = meta.url || "";
                const duration = meta.duration || "";
                const transcript = meta.transcript || "";
                return `<div class="message-media">
                    <audio controls src="${escapeHtml(url)}" style="max-width: 300px;"></audio>
                    ${duration ? `<div class="small text-muted">时长: ${escapeHtml(duration)}</div>` : ""}
                    ${transcript ? `<div class="small mt-1">文字: ${escapeHtml(transcript)}</div>` : ""}
                </div>`;
            }
            if (kind === "file") {
                const url = meta.url || "";
                const name = meta.name || "文件";
                const size = meta.size || "";
                const ext = meta.extension || "";
                return `<div class="message-media">
                    <a href="${escapeHtml(url)}" target="_blank" class="btn btn-sm btn-outline-secondary">📎 ${escapeHtml(name)}</a>
                    ${size ? `<div class="small text-muted">${escapeHtml(size)}</div>` : ""}
                    ${ext ? `<span class="badge text-bg-light">${escapeHtml(ext)}</span>` : ""}
                </div>`;
            }
            if (kind === "link") {
                const url = meta.url || "";
                const title = meta.title || "";
                const desc = meta.description || "";
                const cover = meta.cover || "";
                return `<div class="message-media border p-2 rounded">
                    ${cover ? `<img src="${escapeHtml(cover)}" class="img-thumbnail mb-1" style="max-width: 120px;">` : ""}
                    <div><a href="${escapeHtml(url)}" target="_blank" class="fw-semibold">${escapeHtml(title || url)}</a></div>
                    ${desc ? `<div class="small text-muted">${escapeHtml(desc)}</div>` : ""}
                </div>`;
            }
            if (kind === "contact") {
                const name = meta.name || "";
                const account = meta.account || "";
                const phone = meta.phone || "";
                return `<div class="message-media">
                    <div class="fw-semibold">👤 ${escapeHtml(name)}</div>
                    ${account ? `<div class="small">账号: ${escapeHtml(account)}</div>` : ""}
                    ${phone ? `<div class="small">电话: ${escapeHtml(phone)}</div>` : ""}
                </div>`;
            }
            if (kind === "call") {
                const status = meta.status || "";
                const duration = meta.duration || "";
                const direction = meta.direction || "";
                return `<div class="message-media">
                    <div>📞 ${escapeHtml(status)}</div>
                    ${duration ? `<div class="small">时长: ${escapeHtml(duration)}</div>` : ""}
                    ${direction ? `<div class="small">${direction === "outgoing" ? "呼出" : "呼入"}</div>` : ""}
                </div>`;
            }
            return `<pre class="mb-0 text-wrap" style="white-space: pre-wrap;">${escapeHtml(message.display_content || message.content || "")}</pre>`;
        }

        function renderMessages(messages) {
            allMessages = messages || [];
            if (!messageBody) return;
            messageBody.innerHTML = "";
            const displayedCount = messages.length;
            const totalCount = latestStats?.matched_messages ?? displayedCount;
            if (currentCountBadge) {
                currentCountBadge.textContent = displayedCount ? `当前显示 ${displayedCount} / ${totalCount}` : "暂无结果";
            }
            if (!messages.length) {
                messageBody.innerHTML = '<tr><td colspan="7" class="text-center text-muted">暂无消息。</td></tr>';
                return;
            }
            for (const message of messages) {
                const row = document.createElement("tr");
                const direction = message.direction || "unknown";
                const directionLabel = direction === "outgoing" ? "发出" : direction === "incoming" ? "接收" : "未知";
                const directionClass = direction === "outgoing" ? "text-bg-success" : direction === "incoming" ? "text-bg-primary" : "text-bg-secondary";
                const displayType = message.display_type || message.message_type || "";
                const mediaContent = renderMediaContent(message);
                row.innerHTML = `
                    <td><span class="badge text-bg-light">${escapeHtml(message.conversation || message.talker || "")}</span></td>
                    <td>${escapeHtml(message.timestamp || "")}</td>
                    <td>${escapeHtml(message.sender || "")}</td>
                    <td><span class="badge ${directionClass}">${directionLabel}</span></td>
                    <td><span class="badge text-bg-secondary">${escapeHtml(displayType)}</span></td>
                    <td>${mediaContent}</td>
                    <td><span class="badge text-bg-light">${escapeHtml(message.file_path || "")}</span></td>`;
                messageBody.appendChild(row);
            }
        }

        function renderSimpleList(container, items, badgeClass) {
            if (!container) return;
            container.innerHTML = "";
            if (!items || !items.length) {
                container.innerHTML = '<li class="list-group-item text-muted">暂无数据</li>';
                return;
            }
            for (const item of items) {
                const li = document.createElement("li");
                li.className = "list-group-item d-flex justify-content-between align-items-center";
                li.innerHTML = `<span>${escapeHtml(item.label ?? "未知")}</span><span class="badge ${badgeClass}">${item.count ?? 0}</span>`;
                container.appendChild(li);
            }
        }

        function renderDailyList(container, items) {
            renderSimpleList(container, items, "text-bg-secondary");
        }

        function renderFailedFiles(list) {
            if (!failedFilesAlert || !failedFilesList) return;
            failedFilesList.innerHTML = "";
            if (!list || !list.length) {
                failedFilesAlert.classList.add("d-none");
                return;
            }
            failedFilesAlert.classList.remove("d-none");
            for (const item of list) {
                const li = document.createElement("li");
                li.textContent = item;
                failedFilesList.appendChild(li);
            }
        }

        function renderChart(dailyBreakdown) {
            if (!chartCanvas || !dailyBreakdown || !dailyBreakdown.length) {
                if (chartSection) chartSection.classList.add("d-none");
                return;
            }

            if (chartSection) chartSection.classList.remove("d-none");

            const labels = dailyBreakdown.map(item => item.label || "");
            const data = dailyBreakdown.map(item => item.count || 0);

            if (messageChart) {
                messageChart.destroy();
            }

            const ctx = chartCanvas.getContext("2d");
            messageChart = new Chart(ctx, {
                type: "line",
                data: {
                    labels: labels,
                    datasets: [{
                        label: "消息数量",
                        data: data,
                        borderColor: "rgba(99, 102, 241, 0.8)",
                        backgroundColor: "rgba(99, 102, 241, 0.1)",
                        borderWidth: 2,
                        tension: 0.4,
                        fill: true,
                        pointBackgroundColor: "rgba(99, 102, 241, 1)",
                        pointBorderColor: "#fff",
                        pointBorderWidth: 2,
                        pointRadius: 4,
                        pointHoverRadius: 6
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: true,
                    plugins: {
                        legend: {
                            display: false
                        },
                        tooltip: {
                            backgroundColor: "rgba(15, 23, 42, 0.9)",
                            padding: 12,
                            titleFont: { size: 14 },
                            bodyFont: { size: 13 },
                            cornerRadius: 8
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            grid: {
                                color: "rgba(148, 163, 184, 0.1)"
                            },
                            ticks: {
                                font: { size: 11 },
                                color: "rgba(15, 23, 42, 0.6)"
                            }
                        },
                        x: {
                            grid: {
                                display: false
                            },
                            ticks: {
                                font: { size: 11 },
                                color: "rgba(15, 23, 42, 0.6)",
                                maxRotation: 45,
                                minRotation: 0
                            }
                        }
                    }
                }
            });
        }

        function renderStats(stats) {
            latestStats = stats || null;
            if (!stats) {
                statsSection?.classList.add("d-none");
                renderSimpleList(topContactsList, [], "text-bg-primary");
                renderSimpleList(typeBreakdownList, [], "text-bg-info");
                renderDailyList(dailyBreakdownList, []);
                renderFailedFiles([]);
                if (threadCountBadge) threadCountBadge.textContent = "0";
                return;
            }
            statsSection?.classList.remove("d-none");
            if (statMatched) statMatched.textContent = stats.matched_messages ?? 0;
            if (statTotal) statTotal.textContent = stats.total_messages ?? 0;
            if (statScanned) statScanned.textContent = stats.scanned_files ?? 0;
            if (statParsed) statParsed.textContent = stats.parsed_files ?? 0;
            if (statRange) statRange.innerHTML = `${escapeHtml(stats.earliest_timestamp || "-")}<br>~<br>${escapeHtml(stats.latest_timestamp || "-")}`;
            if (statContacts) statContacts.textContent = (stats.contacts_found || []).join(", ") || "";
            renderSimpleList(topContactsList, stats.top_contacts, "text-bg-primary");
            renderSimpleList(typeBreakdownList, stats.message_type_breakdown, "text-bg-info");
            renderDailyList(dailyBreakdownList, stats.daily_breakdown);
            renderFailedFiles(stats.failed_files);
            renderChart(stats.daily_breakdown);
        }

        function renderThreads(threads) {
            if (!threadContainer) return;
            threadContainer.innerHTML = "";
            if (threadCountBadge) threadCountBadge.textContent = threads?.length ?? 0;
            if (!threads || !threads.length) {
                threadContainer.innerHTML = '<p class="text-muted">暂无会话数据。</p>';
                return;
            }
            for (const thread of threads) {
                const card = document.createElement("div");
                card.className = "thread-card";
                card.dataset.thread = thread.name || "";
                card.innerHTML = `
                    <div class="thread-header">
                        <div>
                            <h3 class="h6 mb-1">${escapeHtml(thread.name || "未命名会话")}</h3>
                            <span class="text-muted small">共 ${thread.count ?? 0} 条消息</span>
                        </div>
                    </div>`;
                const body = document.createElement("div");
                body.className = "thread-body";
                const list = document.createElement("ul");
                list.className = "list-group list-group-flush thread-messages";
                for (const message of thread.messages || []) {
                    const item = document.createElement("li");
                    item.className = "list-group-item";
                    const direction = message.direction || "unknown";
                    const directionLabel = direction === "outgoing" ? "发出" : direction === "incoming" ? "接收" : "未知";
                    const directionClass = direction === "outgoing" ? "text-bg-success" : direction === "incoming" ? "text-bg-primary" : "text-bg-secondary";
                    const displayType = message.display_type || message.message_type || "";
                    const mediaContent = renderMediaContent(message);
                    item.innerHTML = `
                        <div class="d-flex justify-content-between align-items-center mb-1">
                            <span class="fw-semibold">${escapeHtml(message.sender || "")}</span>
                            <span class="text-muted small">${escapeHtml(message.timestamp || "")}</span>
                        </div>
                        <div class="mb-2 small">
                            <span class="badge ${directionClass} me-1">${directionLabel}</span>
                            <span class="badge text-bg-secondary">${escapeHtml(displayType)}</span>
                        </div>
                        <div class="message-content small">${mediaContent}</div>`;
                    list.appendChild(item);
                }
                if (!list.children.length) {
                    const emptyItem = document.createElement("li");
                    emptyItem.className = "list-group-item text-muted";
                    emptyItem.textContent = "暂无消息";
                    list.appendChild(emptyItem);
                }
                body.appendChild(list);
                card.appendChild(body);
                threadContainer.appendChild(card);
            }
        }

        function showError(message) {
            let alertBox = document.getElementById("form-feedback");
            if (!alertBox) {
                alertBox = document.createElement("div");
                alertBox.id = "form-feedback";
                alertBox.className = "alert alert-danger mt-3";
                form.parentNode.insertBefore(alertBox, form.nextSibling);
            }
            alertBox.textContent = message;
        }

        function clearError() {
            const alertBox = document.getElementById("form-feedback");
            if (alertBox) alertBox.remove();
        }

        async function handlePreview(event) {
            event.preventDefault();
            if (!form) return;
            const formData = new FormData(form);
            clearError();
            const response = await fetch("{% url 'chat_extractor:preview' %}", {
                method: "POST",
                headers: {"X-CSRFToken": formData.get("csrfmiddlewaretoken")},
                body: formData,
            });
            if (!response.ok) {
                const payload = await response.json();
                showError(payload.error || JSON.stringify(payload.errors));
                return;
            }
            const payload = await response.json();
            renderStats(payload.stats || null);
            renderMessages(payload.messages || []);
            renderThreads(payload.threads || []);
        }

        previewButton?.addEventListener("click", handlePreview);
        form?.addEventListener("submit", clearError);

        // 主题切换
        const themeToggle = document.getElementById("theme-toggle");
        const currentTheme = localStorage.getItem("theme") || "light";
        document.documentElement.setAttribute("data-theme", currentTheme);
        
        themeToggle?.addEventListener("click", () => {
            const theme = document.documentElement.getAttribute("data-theme");
            const newTheme = theme === "dark" ? "light" : "dark";
            document.documentElement.setAttribute("data-theme", newTheme);
            localStorage.setItem("theme", newTheme);
        });

        // 快捷配置预设
        const togglePresetsBtn = document.getElementById("toggle-presets");
        const presetButtons = document.getElementById("preset-buttons");
        
        togglePresetsBtn?.addEventListener("click", () => {
            presetButtons?.classList.toggle("d-none");
        });

        // 图表切换
        const toggleChartBtn = document.getElementById("toggle-chart");
        const activityChart = document.getElementById("activity-chart");
        
        toggleChartBtn?.addEventListener("click", () => {
            activityChart?.classList.toggle("d-none");
        });

        // 预设配置逻辑
        document.querySelectorAll("[data-preset]").forEach(btn => {
            btn.addEventListener("click", () => {
                const preset = btn.getAttribute("data-preset");
                const now = new Date();
                
                if (preset === "recent-week") {
                    const weekAgo = new Date(now - 7 * 24 * 60 * 60 * 1000);
                    if (dateFromInput) dateFromInput.value = weekAgo.toISOString().split('T')[0];
                    if (dateToInput) dateToInput.value = now.toISOString().split('T')[0];
                } else if (preset === "recent-month") {
                    const monthAgo = new Date(now - 30 * 24 * 60 * 60 * 1000);
                    if (dateFromInput) dateFromInput.value = monthAgo.toISOString().split('T')[0];
                    if (dateToInput) dateToInput.value = now.toISOString().split('T')[0];
                } else if (preset === "text-only") {
                    const typeCheckboxes = document.querySelectorAll('input[name="message_types"]');
                    typeCheckboxes.forEach(cb => {
                        cb.checked = cb.value === "text";
                    });
                } else if (preset === "media-only") {
                    const typeCheckboxes = document.querySelectorAll('input[name="message_types"]');
                    typeCheckboxes.forEach(cb => {
                        cb.checked = ["image", "video", "voice", "file"].includes(cb.value);
                    });
                }
            });
        });

        // 清空表单
        document.getElementById("clear-form")?.addEventListener("click", () => {
            if (confirm("确定要清空所有表单内容吗？")) {
                form?.reset();
                if (keyFeedback) keyFeedback.textContent = "";
            }
        });

        // 表单提交进度指示
        const progressOverlay = document.createElement("div");
        progressOverlay.className = "progress-overlay";
        progressOverlay.innerHTML = `
            <div class="progress-content">
                <div class="progress-spinner"></div>
                <h4>正在提取消息...</h4>
                <p class="text-white-50 mb-0">请稍候,这可能需要几秒钟</p>
            </div>
        `;
        document.body.appendChild(progressOverlay);

        form?.addEventListener("submit", (e) => {
            if (!e.target.checkValidity()) {
                return;
            }
            progressOverlay.classList.add("active");
            setTimeout(() => {
                progressOverlay.classList.remove("active");
            }, 10000); // 最多显示10秒
        });

        // 键盘快捷键
        document.addEventListener("keydown", (e) => {
            // Ctrl + Enter: 提交表单
            if (e.ctrlKey && e.key === "Enter") {
                e.preventDefault();
                form?.requestSubmit();
            }
            // Ctrl + K: 聚焦搜索
            if (e.ctrlKey && e.key === "k") {
                e.preventDefault();
                searchInput?.focus();
            }
            // Esc: 清除搜索
            if (e.key === "Escape" && searchInput === document.activeElement) {
                searchInput.value = "";
                renderMessages(allMessages);
                searchInput.blur();
            }
        });

        // 消息搜索
        searchInput?.addEventListener("input", (e) => {
            const query = e.target.value.toLowerCase().trim();
            if (!query) {
                renderMessages(allMessages);
                return;
            }
            
            const filtered = allMessages.filter(msg => {
                const content = (msg.display_content || msg.content || "").toLowerCase();
                const sender = (msg.sender || "").toLowerCase();
                const conversation = (msg.conversation || msg.talker || "").toLowerCase();
                return content.includes(query) || sender.includes(query) || conversation.includes(query);
            });
            
            renderMessages(filtered);
        });

        // 实时表单验证
        baseDirInput?.addEventListener("blur", () => {
            if (!baseDirInput.value.trim()) {
                baseDirInput.classList.add("is-invalid");
            } else {
                baseDirInput.classList.remove("is-invalid");
            }
        });

        clearKeyButton?.addEventListener("click", () => {
            if (keyInput) keyInput.value = "";
            if (keyFeedback) keyFeedback.textContent = "已清除密钥输入。";
        });

        keyButtons.forEach((button) => {
            button.addEventListener("click", () => {
                const keyValue = button.getAttribute("data-wechat-key") || "";
                const basePath = button.getAttribute("data-base") || "";
                const account = button.getAttribute("data-account") || "";
                if (keyInput) keyInput.value = keyValue;
                if (baseDirInput && !baseDirInput.value && basePath) {
                    baseDirInput.value = basePath;
                }
                if (keyFeedback) {
                    keyFeedback.textContent = account ? `已填充密钥（账号：${account}）` : "已填充密钥。";
                }
            });
        });

        const initialMessages = JSON.parse(document.getElementById("initial-messages").textContent || "[]");
        const initialStatsContent = document.getElementById("initial-stats").textContent || "null";
        const initialStats = JSON.parse(initialStatsContent);
        const initialThreads = JSON.parse(document.getElementById("initial-threads").textContent || "[]");

        renderStats(initialStats);
        renderMessages(initialMessages);
        renderThreads(initialThreads);
    })();
</script>
</body>
</html>
