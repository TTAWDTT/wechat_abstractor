<!DOCTYPE html>
<html lang="zh">
{% load static %}
<head>
    <meta charset="utf-8">
    <title>微信聊天记录提取</title>
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" integrity="sha384-QWTKZyjpPEjISv5WaRU9OFeRpok6YctnYmDr5pNlyT2bRjXh0JMhjY6hW+ALEwIH" crossorigin="anonymous">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css">
    <link rel="stylesheet" href="{% static 'chat_extractor/styles.css' %}">
</head>
<body>
<div class="container py-4">
    <h1 class="mb-4">微信聊天记录提取工具</h1>
    <div class="row g-4">
        <div class="col-lg-4">
            <div class="card shadow-sm">
                <div class="card-body">
                    <form id="extraction-form" method="post" novalidate>
                        {% csrf_token %}
                        {% if error %}
                            <div class="alert alert-danger" role="alert">{{ error }}</div>
                        {% endif %}
                        {% for field in form %}
                            <div class="mb-3">
                                <label class="form-label" for="{{ field.id_for_label }}">{{ field.label }}{% if field.field.required %}<span class="text-danger">*</span>{% endif %}</label>
                                {{ field }}
                                {% if field.help_text %}
                                    <div class="form-text">{{ field.help_text }}</div>
                                {% endif %}
                                {% for error in field.errors %}
                                    <div class="invalid-feedback d-block">{{ error }}</div>
                                {% endfor %}
                            </div>
                        {% endfor %}
                        <button class="btn btn-primary w-100" type="submit">提取</button>
                        <button class="btn btn-outline-secondary w-100 mt-2" type="button" id="preview-button">预览前 50 条</button>
                    </form>
                </div>
            </div>
        </div>
        <div class="col-lg-8">
            <div class="card shadow-sm">
                <div class="card-body">
                    <h2 class="h5">提取结果</h2>
                    {% if stats %}
                        <dl class="row small">
                            <dt class="col-sm-4">总消息数</dt>
                            <dd class="col-sm-8">{{ stats.total_messages }}</dd>
                            <dt class="col-sm-4">匹配消息数</dt>
                            <dd class="col-sm-8">{{ stats.matched_messages }}</dd>
                            <dt class="col-sm-4">扫描文件数</dt>
                            <dd class="col-sm-8">{{ stats.scanned_files }}</dd>
                            <dt class="col-sm-4">成功解析文件</dt>
                            <dd class="col-sm-8">{{ stats.parsed_files }}</dd>
                            <dt class="col-sm-4">发现聊天对象</dt>
                            <dd class="col-sm-8">{{ stats.contacts_found|join:", " }}</dd>
                            <dt class="col-sm-4">时间范围</dt>
                            <dd class="col-sm-8">{{ stats.earliest_timestamp }} ~ {{ stats.latest_timestamp }}</dd>
                            {% if stats.failed_files %}
                                <dt class="col-sm-4">解析失败</dt>
                                <dd class="col-sm-8">
                                    <ul class="mb-0 ps-3">
                                        {% for failure in stats.failed_files %}
                                            <li>{{ failure }}</li>
                                        {% endfor %}
                                    </ul>
                                </dd>
                            {% endif %}
                        </dl>
                    {% else %}
                        <p class="text-muted">提交查询后将在此展示结果。</p>
                    {% endif %}
                    <div class="table-responsive mt-3">
                        <table class="table table-striped table-sm align-middle">
                            <thead>
                            <tr>
                                <th scope="col">时间</th>
                                <th scope="col">聊天对象</th>
                                <th scope="col">发送人</th>
                                <th scope="col">类型</th>
                                <th scope="col">内容</th>
                                <th scope="col">来源文件</th>
                            </tr>
                            </thead>
                            <tbody id="messages-body">
                            {% for message in results %}
                                <tr>
                                    <td>{{ message.timestamp }}</td>
                                    <td>{{ message.talker }}</td>
                                    <td>{{ message.sender }}</td>
                                    <td>{{ message.message_type }}</td>
                                    <td>
                                        <pre class="mb-0 text-wrap" style="white-space: pre-wrap;">{{ message.content }}</pre>
                                    </td>
                                    <td><span class="badge text-bg-light">{{ message.file_path }}</span></td>
                                </tr>
                            {% empty %}
                                <tr>
                                    <td colspan="6" class="text-center text-muted">暂无消息。</td>
                                </tr>
                            {% endfor %}
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js" integrity="sha384-YvpcrYf0tY3lHB60NNkmXc5s9fDVZLESaAA55NDzOxhy9GkcIdslK1eN7N6jIeHz" crossorigin="anonymous"></script>
<script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>
<script>
    flatpickr("#id_start_time", {enableTime: true, dateFormat: "Y-m-d H:i"});
    flatpickr("#id_end_time", {enableTime: true, dateFormat: "Y-m-d H:i"});

    const previewButton = document.getElementById("preview-button");
    const form = document.getElementById("extraction-form");
    const messageBody = document.getElementById("messages-body");

    function renderMessages(messages) {
        messageBody.innerHTML = "";
        if (!messages.length) {
            messageBody.innerHTML = '<tr><td colspan="6" class="text-center text-muted">暂无消息。</td></tr>';
            return;
        }
        for (const message of messages) {
            const row = document.createElement("tr");
            row.innerHTML = `
                <td>${message.timestamp || ""}</td>
                <td>${message.talker || ""}</td>
                <td>${message.sender || ""}</td>
                <td>${message.message_type || ""}</td>
                <td><pre class="mb-0 text-wrap" style="white-space: pre-wrap;">${message.content || ""}</pre></td>
                <td><span class="badge text-bg-light">${message.file_path || ""}</span></td>`;
            messageBody.appendChild(row);
        }
    }

    previewButton?.addEventListener("click", async () => {
        const formData = new FormData(form);
        const response = await fetch("{% url 'chat_extractor:preview' %}", {
            method: "POST",
            headers: {"X-CSRFToken": formData.get("csrfmiddlewaretoken")},
            body: formData,
        });
        if (!response.ok) {
            const payload = await response.json();
            const alertBox = document.createElement("div");
            alertBox.className = "alert alert-danger mt-3";
            alertBox.innerText = payload.error || JSON.stringify(payload.errors);
            form.parentNode.insertBefore(alertBox, form.nextSibling);
            return;
        }
        const payload = await response.json();
        renderMessages(payload.messages || []);
    });
</script>
</body>
</html>
