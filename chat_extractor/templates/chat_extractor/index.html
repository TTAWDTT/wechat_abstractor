<!DOCTYPE html>
<html lang="zh">
{% load static %}
<head>
    <meta charset="utf-8">
    <title>微信聊天记录提取</title>
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" integrity="sha384-QWTKZyjpPEjISv5WaRU9OFeRpok6YctnYmDr5pNlyT2bRjXh0JMhjY6hW+ALEwIH" crossorigin="anonymous">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css">
    <link rel="stylesheet" href="{% static 'chat_extractor/styles.css' %}">
</head>
<body>
<div class="container py-4">
    <h1 class="mb-4">微信聊天记录提取工具</h1>
    <div class="row g-4">
        <div class="col-lg-4">
            <div class="card shadow-sm">
                <div class="card-body">
                    <form id="extraction-form" method="post" novalidate>
                        {% csrf_token %}
                        {% if error %}
                            <div class="alert alert-danger" role="alert">{{ error }}</div>
                        {% endif %}
                        {% for field in form %}
                            <div class="mb-3">
                                <label class="form-label" for="{{ field.id_for_label }}">{{ field.label }}{% if field.field.required %}<span class="text-danger">*</span>{% endif %}</label>
                                {{ field }}
                                {% if field.help_text %}
                                    <div class="form-text">{{ field.help_text }}</div>
                                {% endif %}
                                {% for error in field.errors %}
                                    <div class="invalid-feedback d-block">{{ error }}</div>
                                {% endfor %}
                            </div>
                        {% endfor %}
                        <button class="btn btn-primary w-100" type="submit">提取</button>
                        <div class="d-flex flex-column gap-2 mt-2">
                            <button class="btn btn-outline-secondary w-100" type="button" id="preview-button">预览前 50 条</button>
                            <button class="btn btn-success w-100" type="submit" formaction="{% url 'chat_extractor:export' %}" formtarget="_blank">导出为 TXT</button>
                        </div>
                    </form>
                </div>
            </div>
        </div>
        <div class="col-lg-8">
            <div class="card shadow-sm">
                <div class="card-body">
                    <div class="d-flex align-items-center justify-content-between mb-3">
                        <h2 class="h5 mb-0">提取结果</h2>
                        <span class="badge rounded-pill bg-secondary-subtle text-secondary" id="current-count">
                            {% if stats %}当前显示 {{ results|length }} / {{ stats.matched_messages }}{% else %}暂无结果{% endif %}
                        </span>
                    </div>
                    <div id="stats-section" class="mb-4 {% if not stats %}d-none{% endif %}">
                        <div class="row row-cols-1 row-cols-md-3 g-3 mb-3">
                            <div class="col">
                                <div class="stat-card h-100">
                                    <div class="stat-label">匹配消息</div>
                                    <div class="stat-value" id="stat-matched">{{ stats.matched_messages|default:"0" }}</div>
                                    <div class="stat-sub">总计 <span id="stat-total">{{ stats.total_messages|default:"0" }}</span></div>
                                </div>
                            </div>
                            <div class="col">
                                <div class="stat-card h-100">
                                    <div class="stat-label">扫描文件</div>
                                    <div class="stat-value" id="stat-scanned">{{ stats.scanned_files|default:"0" }}</div>
                                    <div class="stat-sub">成功 <span id="stat-parsed">{{ stats.parsed_files|default:"0" }}</span></div>
                                </div>
                            </div>
                            <div class="col">
                                <div class="stat-card h-100">
                                    <div class="stat-label">时间范围</div>
                                    <div class="stat-value small" id="stat-range">
                                        {% if stats %}{{ stats.earliest_timestamp }}<br>~<br>{{ stats.latest_timestamp }}{% else %}--{% endif %}
                                    </div>
                                    <div class="stat-sub" id="stat-contacts">{{ stats.contacts_found|join:", " }}</div>
                                </div>
                            </div>
                        </div>
                        <div class="row row-cols-1 row-cols-md-2 g-3 mb-3">
                            <div class="col">
                                <div class="card border-0 shadow-sm h-100">
                                    <div class="card-header bg-transparent fw-semibold">高频联系人</div>
                                    <div class="card-body p-3">
                                        <ul class="list-group list-group-flush small" id="top-contacts">
                                            {% if stats and stats.top_contacts %}
                                                {% for item in stats.top_contacts %}
                                                    <li class="list-group-item d-flex justify-content-between align-items-center">
                                                        <span>{{ item.label }}</span>
                                                        <span class="badge text-bg-primary">{{ item.count }}</span>
                                                    </li>
                                                {% endfor %}
                                            {% else %}
                                                <li class="list-group-item text-muted">暂无数据</li>
                                            {% endif %}
                                        </ul>
                                    </div>
                                </div>
                            </div>
                            <div class="col">
                                <div class="card border-0 shadow-sm h-100">
                                    <div class="card-header bg-transparent fw-semibold">消息类型分布</div>
                                    <div class="card-body p-3">
                                        <ul class="list-group list-group-flush small" id="type-breakdown">
                                            {% if stats and stats.message_type_breakdown %}
                                                {% for item in stats.message_type_breakdown %}
                                                    <li class="list-group-item d-flex justify-content-between align-items-center">
                                                        <span>{{ item.label }}</span>
                                                        <span class="badge text-bg-info">{{ item.count }}</span>
                                                    </li>
                                                {% endfor %}
                                            {% else %}
                                                <li class="list-group-item text-muted">暂无数据</li>
                                            {% endif %}
                                        </ul>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="card border-0 shadow-sm mb-3">
                            <div class="card-header bg-transparent fw-semibold">按天统计</div>
                            <div class="card-body p-3">
                                <ul class="list-group list-group-flush small" id="daily-breakdown">
                                    {% if stats and stats.daily_breakdown %}
                                        {% for item in stats.daily_breakdown %}
                                            <li class="list-group-item d-flex justify-content-between align-items-center">
                                                <span>{{ item.label }}</span>
                                                <span class="badge text-bg-secondary">{{ item.count }}</span>
                                            </li>
                                        {% endfor %}
                                    {% else %}
                                        <li class="list-group-item text-muted">暂无数据</li>
                                    {% endif %}
                                </ul>
                            </div>
                        </div>
                        <div id="failed-files" class="alert alert-warning small {% if not stats or not stats.failed_files %}d-none{% endif %}">
                            <strong>解析失败文件</strong>
                            <ul class="mb-0 mt-2" id="failed-files-list">
                                {% if stats and stats.failed_files %}
                                    {% for failure in stats.failed_files %}
                                        <li>{{ failure }}</li>
                                    {% endfor %}
                                {% endif %}
                            </ul>
                        </div>
                    </div>
                    <ul class="nav nav-tabs" id="result-tabs" role="tablist">
                        <li class="nav-item" role="presentation">
                            <button class="nav-link active" id="table-tab" data-bs-toggle="tab" data-bs-target="#table-view" type="button" role="tab">表格视图</button>
                        </li>
                        <li class="nav-item" role="presentation">
                            <button class="nav-link" id="thread-tab" data-bs-toggle="tab" data-bs-target="#thread-view" type="button" role="tab">
                                会话视图 <span class="badge text-bg-secondary ms-1" id="thread-count">{{ threads|length }}</span>
                            </button>
                        </li>
                    </ul>
                    <div class="tab-content mt-3">
                        <div class="tab-pane fade show active" id="table-view" role="tabpanel">
                            <div class="table-responsive">
                                <table class="table table-striped table-hover table-sm align-middle">
                                    <thead>
                                    <tr>
                                        <th scope="col">会话</th>
                                        <th scope="col">时间</th>
                                        <th scope="col">发送人</th>
                                        <th scope="col">方向</th>
                                        <th scope="col">类型</th>
                                        <th scope="col">内容</th>
                                        <th scope="col">来源文件</th>
                                    </tr>
                                    </thead>
                                    <tbody id="messages-body">
                                    {% for message in results %}
                                        <tr>
                                            <td><span class="badge text-bg-light">{{ message.conversation }}</span></td>
                                            <td>{{ message.timestamp }}</td>
                                            <td>{{ message.sender }}</td>
                                            <td>
                                                {% if message.direction == 'outgoing' %}
                                                    <span class="badge text-bg-success">发出</span>
                                                {% elif message.direction == 'incoming' %}
                                                    <span class="badge text-bg-primary">接收</span>
                                                {% else %}
                                                    <span class="badge text-bg-secondary">未知</span>
                                                {% endif %}
                                            </td>
                                            <td><span class="badge text-bg-secondary">{{ message.message_type }}</span></td>
                                            <td>
                                                <pre class="mb-0 text-wrap" style="white-space: pre-wrap;">{{ message.content }}</pre>
                                            </td>
                                            <td><span class="badge text-bg-light">{{ message.file_path }}</span></td>
                                        </tr>
                                    {% empty %}
                                        <tr>
                                            <td colspan="7" class="text-center text-muted">暂无消息。</td>
                                        </tr>
                                    {% endfor %}
                                    </tbody>
                                </table>
                            </div>
                        </div>
                        <div class="tab-pane fade" id="thread-view" role="tabpanel">
                            <div id="thread-container">
                                {% if threads %}
                                    {% for thread in threads %}
                                        <div class="thread-card" data-thread="{{ thread.name }}">
                                            <div class="thread-header">
                                                <div>
                                                    <span class="text-muted small">共 {{ thread.count }} 条消息</span>
                                                </div>
                                            </div>
                                            <div class="thread-body">
                                                <ul class="list-group list-group-flush thread-messages">
                                                    {% for message in thread.messages %}
                                                        <li class="list-group-item">
                                                            <div class="d-flex justify-content-between align-items-center mb-1">
                                                                <span class="fw-semibold">{{ message.sender }}</span>
                                                                <span class="text-muted small">{{ message.timestamp }}</span>
                                                            </div>
                                                            <div class="mb-2 small">
                                                                {% if message.direction == 'outgoing' %}
                                                                    <span class="badge text-bg-success me-1">发出</span>
                                                                {% elif message.direction == 'incoming' %}
                                                                    <span class="badge text-bg-primary me-1">接收</span>
                                                                {% else %}
                                                                    <span class="badge text-bg-secondary me-1">未知</span>
                                                                {% endif %}
                                                                <span class="badge text-bg-secondary">{{ message.message_type }}</span>
                                                            </div>
                                                            <div class="message-content small">{{ message.content }}</div>
                                                        </li>
                                                    {% endfor %}
                                                </ul>
                                            </div>
                                        </div>
                                    {% endfor %}
                                {% else %}
                                    <p class="text-muted">暂无会话数据。</p>
                                {% endif %}
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% if results is not None %}{{ results|json_script:"initial-messages" }}{% else %}<script id="initial-messages" type="application/json">[]</script>{% endif %}
{% if stats is not None %}{{ stats|json_script:"initial-stats" }}{% else %}<script id="initial-stats" type="application/json">null</script>{% endif %}
{% if threads is not None %}{{ threads|json_script:"initial-threads" }}{% else %}<script id="initial-threads" type="application/json">[]</script>{% endif %}
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js" integrity="sha384-YvpcrYf0tY3lHB60NNkmXc5s9fDVZLESaAA55NDzOxhy9GkcIdslK1eN7N6jIeHz" crossorigin="anonymous"></script>
<script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>
<script>
    flatpickr("#id_start_time", {enableTime: true, dateFormat: "Y-m-d H:i"});
    flatpickr("#id_end_time", {enableTime: true, dateFormat: "Y-m-d H:i"});

    const previewButton = document.getElementById("preview-button");
    const form = document.getElementById("extraction-form");
    const messageBody = document.getElementById("messages-body");
    const statsSection = document.getElementById("stats-section");
    const statMatched = document.getElementById("stat-matched");
    const statTotal = document.getElementById("stat-total");
    const statScanned = document.getElementById("stat-scanned");
    const statParsed = document.getElementById("stat-parsed");
    const statRange = document.getElementById("stat-range");
    const statContacts = document.getElementById("stat-contacts");
    const topContactsList = document.getElementById("top-contacts");
    const typeBreakdownList = document.getElementById("type-breakdown");
    const dailyBreakdownList = document.getElementById("daily-breakdown");
    const failedFilesAlert = document.getElementById("failed-files");
    const failedFilesList = document.getElementById("failed-files-list");
    const threadContainer = document.getElementById("thread-container");
    const threadCountBadge = document.getElementById("thread-count");
    const currentCountBadge = document.getElementById("current-count");
    let latestStats = null;

    function escapeHtml(value) {
        const map = {
            "&": "&amp;",
            "<": "&lt;",
            ">": "&gt;",
            '"': "&quot;",
            "'": "&#39;",
        };
        return (value ?? "").replace(/[&<>">'?]/g, (match) => map[match] || match);
    }

    function renderMessages(messages) {
        messageBody.innerHTML = "";
        const displayedCount = messages.length;
        const totalCount = latestStats?.matched_messages ?? displayedCount;
        if (currentCountBadge) {
            currentCountBadge.textContent = displayedCount
                ? `当前显示 ${displayedCount} / ${totalCount}`
                : "暂无结果";
        }
        if (!messages.length) {
            messageBody.innerHTML = '<tr><td colspan="7" class="text-center text-muted">暂无消息。</td></tr>';
            return;
        }
        for (const message of messages) {
            const row = document.createElement("tr");
            const direction = message.direction || "unknown";
            const directionLabel = direction === "outgoing" ? "发出" : direction === "incoming" ? "接收" : "未知";
            const directionClass = direction === "outgoing"
                ? "text-bg-success"
                : direction === "incoming"
                    ? "text-bg-primary"
                    : "text-bg-secondary";
            row.innerHTML = `
                <td><span class="badge text-bg-light">${escapeHtml(message.conversation || message.talker || "")}</span></td>
                <td>${escapeHtml(message.timestamp || "")}</td>
                <td>${escapeHtml(message.sender || "")}</td>
                <td><span class="badge ${directionClass}">${directionLabel}</span></td>
                <td><span class="badge text-bg-secondary">${escapeHtml(message.message_type || "")}</span></td>
                <td><pre class="mb-0 text-wrap" style="white-space: pre-wrap;">${escapeHtml(message.content || "")}</pre></td>
                <td><span class="badge text-bg-light">${escapeHtml(message.file_path || "")}</span></td>`;
            messageBody.appendChild(row);
        }
    }

    function renderList(container, items, badgeClass = "text-bg-primary") {
        if (!container) {
            return;
        }
        container.innerHTML = "";
        if (!items || !items.length) {
            container.innerHTML = '<li class="list-group-item text-muted">暂无数据</li>';
            return;
        }
        for (const item of items) {
            const li = document.createElement("li");
            li.className = "list-group-item d-flex justify-content-between align-items-center";
            li.innerHTML = `<span>${escapeHtml(item.label ?? "未知")}</span><span class="badge ${badgeClass}">${item.count ?? 0}</span>`;
            container.appendChild(li);
        }
    }

    function renderDailyList(container, items) {
        if (!container) {
            return;
        }
        container.innerHTML = "";
        if (!items || !items.length) {
            container.innerHTML = '<li class="list-group-item text-muted">暂无数据</li>';
            return;
        }
        for (const item of items) {
            const li = document.createElement("li");
            li.className = "list-group-item d-flex justify-content-between align-items-center";
            li.innerHTML = `<span>${escapeHtml(item.label ?? "未知")}</span><span class="badge text-bg-secondary">${item.count ?? 0}</span>`;
            container.appendChild(li);
        }
    }

    function renderFailedFiles(list) {
        if (!failedFilesAlert || !failedFilesList) {
            return;
        }
        failedFilesList.innerHTML = "";
        if (!list || !list.length) {
            failedFilesAlert.classList.add("d-none");
            return;
        }
        failedFilesAlert.classList.remove("d-none");
        for (const item of list) {
            const li = document.createElement("li");
            li.textContent = item;
            failedFilesList.appendChild(li);
        }
    }

    function renderStats(stats) {
        latestStats = stats || null;
        if (!stats) {
            if (statsSection) {
                statsSection.classList.add("d-none");
            }
            renderList(topContactsList, []);
            renderList(typeBreakdownList, []);
            renderDailyList(dailyBreakdownList, []);
            renderFailedFiles([]);
            if (threadCountBadge) {
                threadCountBadge.textContent = "0";
            }
            return;
        }
        if (statsSection) {
            statsSection.classList.remove("d-none");
        }
        if (statMatched) statMatched.textContent = stats.matched_messages ?? 0;
        if (statTotal) statTotal.textContent = stats.total_messages ?? 0;
        if (statScanned) statScanned.textContent = stats.scanned_files ?? 0;
        if (statParsed) statParsed.textContent = stats.parsed_files ?? 0;
        if (statRange) statRange.innerHTML = `${escapeHtml(stats.earliest_timestamp || "-")}<br>~<br>${escapeHtml(stats.latest_timestamp || "-")}`;
        if (statContacts) statContacts.textContent = (stats.contacts_found || []).join(", ") || "";
    renderList(topContactsList, stats.top_contacts, "text-bg-primary");
    renderList(typeBreakdownList, stats.message_type_breakdown, "text-bg-info");
        renderDailyList(dailyBreakdownList, stats.daily_breakdown);
        renderFailedFiles(stats.failed_files);
    }

    function renderThreads(threads) {
        if (!threadContainer) {
            return;
        }
        threadContainer.innerHTML = "";
        if (threadCountBadge) {
            threadCountBadge.textContent = threads?.length ?? 0;
        }
        if (!threads || !threads.length) {
            threadContainer.innerHTML = '<p class="text-muted">暂无会话数据。</p>';
            return;
        }
        for (const thread of threads) {
            const card = document.createElement("div");
            card.className = "thread-card";
            card.setAttribute("data-thread", thread.name || "");

            const header = document.createElement("div");
            header.className = "thread-header";
            header.innerHTML = `
                <div>
                    <h3 class="h6 mb-1">${escapeHtml(thread.name || "未命名会话")}</h3>
                    <span class="text-muted small">共 ${thread.count ?? 0} 条消息</span>
                </div>`;
            card.appendChild(header);

            const body = document.createElement("div");
            body.className = "thread-body";
            const list = document.createElement("ul");
            list.className = "list-group list-group-flush thread-messages";

            for (const message of thread.messages || []) {
                const item = document.createElement("li");
                item.className = "list-group-item";
                const direction = message.direction || "unknown";
                const directionLabel = direction === "outgoing" ? "发出" : direction === "incoming" ? "接收" : "未知";
                const directionClass = direction === "outgoing"
                    ? "text-bg-success"
                    : direction === "incoming"
                        ? "text-bg-primary"
                        : "text-bg-secondary";
                item.innerHTML = `
                    <div class="d-flex justify-content-between align-items-center mb-1">
                        <span class="fw-semibold">${escapeHtml(message.sender || "")}</span>
                        <span class="text-muted small">${escapeHtml(message.timestamp || "")}</span>
                    </div>
                    <div class="mb-2 small">
                        <span class="badge ${directionClass} me-1">${directionLabel}</span>
                        <span class="badge text-bg-secondary">${escapeHtml(message.message_type || "")}</span>
                    </div>
                    <div class="message-content small">${escapeHtml(message.content || "")}</div>`;
                list.appendChild(item);
            }
            if (!list.children.length) {
                const emptyItem = document.createElement("li");
                emptyItem.className = "list-group-item text-muted";
                emptyItem.textContent = "暂无消息";
                list.appendChild(emptyItem);
            }
            body.appendChild(list);
            card.appendChild(body);
            threadContainer.appendChild(card);
        }
    }

    function showError(message) {
        let alertBox = document.getElementById("form-feedback");
        if (!alertBox) {
            alertBox = document.createElement("div");
            alertBox.id = "form-feedback";
            alertBox.className = "alert alert-danger mt-3";
            form.parentNode.insertBefore(alertBox, form.nextSibling);
        }
        alertBox.textContent = message;
    }

    function clearError() {
        const alertBox = document.getElementById("form-feedback");
        if (alertBox) {
            alertBox.remove();
        }
    }

    previewButton?.addEventListener("click", async () => {
        const formData = new FormData(form);
        clearError();
        const response = await fetch("{% url 'chat_extractor:preview' %}", {
            method: "POST",
            headers: {"X-CSRFToken": formData.get("csrfmiddlewaretoken")},
            body: formData,
        });
        if (!response.ok) {
            const payload = await response.json();
            showError(payload.error || JSON.stringify(payload.errors));
            return;
        }
        const payload = await response.json();
        renderStats(payload.stats || null);
        renderMessages(payload.messages || []);
        renderThreads(payload.threads || []);
    });

    const initialMessages = JSON.parse(document.getElementById("initial-messages").textContent || "[]");
    const initialStatsContent = document.getElementById("initial-stats").textContent || "null";
    const initialStats = JSON.parse(initialStatsContent);
    const initialThreads = JSON.parse(document.getElementById("initial-threads").textContent || "[]");

    renderStats(initialStats);
    renderMessages(initialMessages);
    renderThreads(initialThreads);
</script>
</body>
</html>
